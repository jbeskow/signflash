<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<title>SignFlash</title>
<link rel="icon" href="icons/signflash-color.png" type="image/png">
<link rel="apple-touch-icon" href="icons/signflash-color.png">
<link rel="manifest" href="manifest.json">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  overflow-x: hidden;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #1a1a2e;
  color: #e0e0e0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.progress-bar-container {
  width: 100%;
  background: #16213e;
  padding: 8px 16px;
  position: sticky;
  top: 0;
  z-index: 10;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.top-row {
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
}

.settings-wrap {
  position: relative;
}

.btn-settings {
  background: none;
  border: none;
  color: #888;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  display: flex;
  align-items: center;
}

.btn-settings:hover { color: #ccc; background: rgba(255,255,255,0.05); }

.settings-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 100%;
  margin-top: 4px;
  background: #16213e;
  border: 1px solid #0f3460;
  border-radius: 8px;
  padding: 4px 0;
  min-width: 180px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.4);
  z-index: 20;
}

.settings-menu.open { display: block; }

.settings-item {
  display: block;
  width: 100%;
  padding: 10px 16px;
  background: none;
  border: none;
  color: #e0e0e0;
  font-size: 14px;
  text-align: left;
  cursor: pointer;
}

.settings-item:hover { background: rgba(255,255,255,0.05); }
.settings-item.danger { color: #e74c3c; }

#streak-value {
  min-width: 16px;
  text-align: center;
  font-weight: 600;
}

.stats-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: #1a1a2e;
  z-index: 100;
  flex-direction: column;
}

.stats-overlay.open {
  display: flex;
}

.stats-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: #16213e;
  border-bottom: 1px solid #0f3460;
}

.stats-header h2 {
  font-size: 18px;
  font-weight: 600;
}

.btn-close-stats {
  background: none;
  border: none;
  color: #888;
  font-size: 24px;
  cursor: pointer;
  padding: 4px 8px;
}

.btn-close-stats:hover { color: #ccc; }

.stats-list {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 8px 0;
}

.stats-section-title {
  padding: 10px 16px 4px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stats-section-title.mastered { color: #4ecca3; }
.stats-section-title.learning { color: #f0c040; }

.stats-row {
  display: flex;
  align-items: center;
  padding: 8px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.04);
}

.stats-word {
  flex: 1;
  font-size: 16px;
}

.stats-counts {
  display: flex;
  gap: 12px;
  font-size: 13px;
}

.stats-streak { color: #f0c040; letter-spacing: 1px; }
.stats-total { color: #888; min-width: 24px; text-align: right; }

.stats-empty {
  padding: 24px 16px;
  text-align: center;
  color: #555;
  font-size: 14px;
}

.progress-stats {
  display: flex;
  justify-content: center;
  gap: 24px;
  font-size: 13px;
  margin-bottom: 6px;
  flex-wrap: wrap;
}

.progress-stats span { opacity: 0.85; display: inline-block; }
.stat-mastered { color: #4ecca3; }
.stat-learning { color: #f0c040; }
.stat-unseen { color: #888; }

.progress-track {
  width: 100%;
  max-width: 500px;
  height: 6px;
  background: #0f3460;
  border-radius: 3px;
  overflow: hidden;
  margin: 0 auto;
  display: flex;
}

.progress-fill-mastered {
  background: #4ecca3;
  height: 100%;
  transition: width 0.4s;
}

.progress-fill-learning {
  background: #f0c040;
  height: 100%;
  transition: width 0.4s;
}

.app {
  width: 100%;
  max-width: 500px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  flex: 1;
}

.video-container {
  width: 100%;
  aspect-ratio: 4 / 3;
  background: #000;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
}

video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  transition: transform 0.3s ease;
}

.video-controls {
  position: absolute;
  bottom: 8px;
  right: 8px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.video-controls-top {
  position: absolute;
  top: 8px;
  left: 8px;
}

.video-menu {
  position: absolute;
  top: 8px;
  right: 8px;
}

.video-container.face-zoom video {
  transform: scale(2);
  transform-origin: 50% 25%;
}

#btn-face.active { background: rgba(78,204,163,0.5); }

.btn-icon {
  background: rgba(0,0,0,0.6);
  border: none;
  color: #fff;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
}

.btn-icon:hover { background: rgba(0,0,0,0.8); }
#btn-slow.speed-1 {
  background: linear-gradient(to right, rgba(78,204,163,0.55) 50%, rgba(0,0,0,0.6) 50%);
}
#btn-slow.speed-2 { background: rgba(78,204,163,0.5); }

.input-row {
  display: flex;
  gap: 8px;
  width: 100%;
}

#answer-input {
  flex: 1;
  padding: 12px 16px;
  font-size: 18px;
  border: 2px solid #0f3460;
  border-radius: 8px;
  background: #16213e;
  color: #e0e0e0;
  outline: none;
  transition: border-color 0.2s;
}

#answer-input:focus { border-color: #4ecca3; }
#answer-input::placeholder { color: #555; }

.btn {
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s, transform 0.1s;
}

.btn:active { transform: scale(0.97); }

.btn-submit {
  background: #4ecca3;
  color: #1a1a2e;
}

.btn-submit:hover { background: #3dbb94; }

.btn-alt {
  background: #0f3460;
  color: #e0e0e0;
  font-size: 14px;
  padding: 12px 14px;
}

.btn-alt:hover { background: #1a4a7a; }

.alternatives {
  display: none;
  width: 100%;
  gap: 8px;
}

.alternatives.visible {
  display: grid;
  grid-template-columns: 1fr 1fr;
}

.alt-btn {
  padding: 10px;
  border: 2px solid #0f3460;
  border-radius: 8px;
  background: #16213e;
  color: #e0e0e0;
  font-size: 15px;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
}

.alt-btn:hover {
  border-color: #4ecca3;
  background: #1a3a5e;
}

.feedback {
  width: 100%;
  padding: 16px;
  border-radius: 10px;
  text-align: center;
  font-size: 18px;
  font-weight: 600;
  display: none;
}

.feedback.correct {
  display: block;
  background: rgba(78, 204, 163, 0.15);
  color: #4ecca3;
  border: 2px solid #4ecca3;
}

.feedback.incorrect {
  display: block;
  background: rgba(231, 76, 60, 0.15);
  color: #e74c3c;
  border: 2px solid #e74c3c;
}

.feedback .correct-answer {
  margin-top: 6px;
  font-size: 22px;
  color: #f0c040;
}

.streak-stars {
  color: #f0c040;
  font-size: 20px;
  letter-spacing: 2px;
  margin-left: 4px;
}

.feedback.mastered-celebration {
  background: rgba(240, 192, 64, 0.15);
  border-color: #f0c040;
  color: #f0c040;
  animation: celebrate 0.6s ease-out;
}

@keyframes celebrate {
  0% { transform: scale(0.8); opacity: 0; }
  50% { transform: scale(1.08); }
  100% { transform: scale(1); opacity: 1; }
}

.stat-mastered.pulse {
  animation: counter-pulse 0.6s ease-out;
}

@keyframes counter-pulse {
  0% { transform: scale(1); }
  30% { transform: scale(1.4); color: #f0c040; }
  100% { transform: scale(1); }
}

.milestone {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.5);
  background: rgba(22, 33, 62, 0.95);
  border: 2px solid #f0c040;
  border-radius: 16px;
  padding: 24px 32px;
  text-align: center;
  color: #f0c040;
  font-size: 20px;
  font-weight: 700;
  z-index: 200;
  opacity: 0;
  pointer-events: none;
  animation: milestone-pop 2.5s ease-out forwards;
}

@keyframes milestone-pop {
  0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
  15% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
  25% { transform: translate(-50%, -50%) scale(1); }
  75% { opacity: 1; }
  100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
}

.mode-toggle {
  display: flex;
  gap: 0;
  flex-shrink: 0;
}

.mode-btn {
  flex: 1;
  padding: 8px;
  border: 2px solid #0f3460;
  background: transparent;
  color: #888;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.mode-btn:first-child {
  border-radius: 8px 0 0 8px;
  border-right: 1px solid #0f3460;
}

.mode-btn:last-child {
  border-radius: 0 8px 8px 0;
  border-left: 1px solid #0f3460;
}

.mode-btn.active {
  background: #0f3460;
  color: #e0e0e0;
  border-color: #0f3460;
}

.mode-btn:disabled {
  opacity: 0.35;
  cursor: not-allowed;
}

.mode-btn:hover:not(.active):not(:disabled) {
  color: #ccc;
  background: rgba(255,255,255,0.03);
}

.phrase-text {
  width: 100%;
  padding: 12px 16px;
  background: #16213e;
  border-radius: 8px;
  font-size: 16px;
  line-height: 1.5;
  color: #ccc;
  text-align: center;
  display: none;
}

.wordlist-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
}

.wordlist-select-wrap {
  position: relative;
  flex: 1;
}

.wordlist-btn {
  width: 100%;
  padding: 8px 12px;
  background: #0f3460;
  border: 2px solid #0f3460;
  border-radius: 8px;
  color: #e0e0e0;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  text-align: left;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: background 0.2s;
}

.wordlist-btn:hover { background: #1a4a7a; }

.wordlist-btn .wl-count {
  color: #888;
  font-weight: 400;
}

.wordlist-btn::after {
  content: "\25BE";
  margin-left: auto;
  font-size: 12px;
  color: #888;
}

.wordlist-menu {
  display: none;
  position: absolute;
  left: 0;
  right: 0;
  top: 100%;
  margin-top: 4px;
  background: #16213e;
  border: 1px solid #0f3460;
  border-radius: 8px;
  padding: 4px 0;
  box-shadow: 0 4px 16px rgba(0,0,0,0.4);
  z-index: 30;
  max-height: 300px;
  overflow-y: auto;
}

.wordlist-menu.open { display: block; }

.wordlist-menu-item {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
  padding: 10px 12px;
  background: none;
  border: none;
  color: #e0e0e0;
  font-size: 14px;
  text-align: left;
  cursor: pointer;
}

.wordlist-menu-item:hover { background: rgba(255,255,255,0.05); }
.wordlist-menu-item.active { background: rgba(78,204,163,0.1); }

.wordlist-menu-item .wl-check {
  width: 18px;
  text-align: center;
  color: #4ecca3;
  flex-shrink: 0;
}

.wordlist-menu-item .wl-name { flex: 1; }

.wordlist-menu-item .wl-count {
  color: #888;
  font-size: 13px;
}

.completion-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(26, 26, 46, 0.95);
  z-index: 250;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  gap: 16px;
}

.completion-overlay.open {
  display: flex;
  animation: celebrate 0.5s ease-out;
}

.completion-title {
  font-size: 32px;
  font-weight: 700;
  color: #f0c040;
  animation: completion-title-in 0.5s 0.2s ease-out both;
}

.completion-subtitle {
  font-size: 18px;
  color: #ccc;
  animation: completion-title-in 0.5s 0.35s ease-out both;
}

@keyframes completion-title-in {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}

.completion-stars {
  font-size: 52px;
  letter-spacing: 10px;
}

.completion-stars span {
  display: inline-block;
  opacity: 0;
  animation: star-pop 0.45s ease-out both;
}
.completion-stars span:nth-child(1) { animation-delay: 0.05s; }
.completion-stars span:nth-child(2) { animation-delay: 0.2s; }
.completion-stars span:nth-child(3) { animation-delay: 0.35s; }

@keyframes star-pop {
  0%   { transform: scale(0) rotate(-30deg); opacity: 0; }
  65%  { transform: scale(1.4) rotate(8deg); opacity: 1; }
  100% { transform: scale(1) rotate(0); opacity: 1; }
}

@keyframes confetti-fly {
  0%   { transform: translate(0, 0) rotate(0deg); opacity: 1; }
  80%  { opacity: 1; }
  100% { transform: translate(var(--cx), var(--cy)) rotate(var(--cr)); opacity: 0; }
}

.btn-completion-close {
  margin-top: 16px;
  padding: 12px 32px;
  background: #4ecca3;
  color: #1a1a2e;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
}

.btn-completion-close:hover { background: #3dbb94; }

@media (max-width: 520px) {
  .app { padding: 10px; gap: 12px; }
  #answer-input { font-size: 16px; padding: 10px 12px; }
  .btn { padding: 10px 14px; font-size: 14px; }
  .btn-alt { padding: 10px 10px; font-size: 13px; }
  .progress-stats { font-size: 12px; gap: 12px; }
}
</style>
</head>
<body>

<div class="progress-bar-container">
  <div class="top-row">
    <div class="progress-stats">
      <span class="stat-mastered" id="stat-mastered">Klara: 0</span>
      <span class="stat-learning" id="stat-learning">L√§r sig: 0</span>
      <span class="stat-unseen" id="stat-unseen">Nya: 0</span>
    </div>
  </div>
  <div class="progress-track">
    <div class="progress-fill-mastered" id="progress-mastered"></div>
    <div class="progress-fill-learning" id="progress-learning"></div>
  </div>
</div>

<div class="app">
  <div class="wordlist-bar">
    <div class="wordlist-select-wrap">
      <button class="wordlist-btn" id="wordlist-btn">
        <span id="wordlist-btn-name">Grunder 1</span>
        <span class="wl-count" id="wordlist-btn-count"></span>
      </button>
      <div class="wordlist-menu" id="wordlist-menu"></div>
    </div>
    <div class="mode-toggle">
      <button class="mode-btn active" id="btn-mode-word">Ord</button>
      <button class="mode-btn" id="btn-mode-phrase">Fraser</button>
    </div>
  </div>

  <div class="video-container">
    <video id="sign-video" autoplay loop muted playsinline>
      <source id="video-source" src="" type="video/mp4">
    </video>
    <div class="video-controls-top">
      <button class="btn-icon" id="btn-info" title="Om SignFlash"><svg width="12" height="22" viewBox="0 0 53.086 122.88" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M0.438,119.945v-17.962c0-1.62,1.313-2.935,2.934-2.935h3.614c0.106-0.078,0.236-0.199,0.388-0.361 c0.188-0.2,0.327-0.376,0.414-0.526V65.834c-0.092-0.16-0.238-0.349-0.437-0.565c-0.04-0.043-0.078-0.088-0.115-0.133 c-0.094-0.097-0.179-0.173-0.254-0.229H2.935C1.314,64.906,0,63.592,0,61.972V42.865c0-1.62,1.314-2.934,2.935-2.934h35.242 c2.598,0,4.553,1.097,5.868,3.278c1.03,1.708,1.544,4.071,1.544,7.08v47.842c0.083,0.12,0.227,0.283,0.431,0.488 c0.202,0.201,0.367,0.346,0.494,0.43h3.638c1.62,0,2.935,1.314,2.935,2.935v17.962c0,1.62-1.314,2.935-2.935,2.935H3.373 C1.752,122.88,0.438,121.565,0.438,119.945L0.438,119.945z M6.307,104.918v12.093h40.91v-12.093h-0.912 c-0.864,0-1.71-0.233-2.544-0.693c-0.65-0.358-1.278-0.845-1.89-1.457c-0.608-0.607-1.097-1.244-1.461-1.911 c-0.457-0.836-0.689-1.678-0.689-2.523V50.289c0-1.93-0.231-3.284-0.696-4.054c-0.175-0.29-0.457-0.436-0.848-0.436H5.869v13.237 h1.35c0.865,0,1.723,0.245,2.57,0.731c0.581,0.334,1.148,0.789,1.7,1.362c0.06,0.055,0.117,0.112,0.173,0.173 c0.584,0.637,1.039,1.264,1.359,1.878c0.421,0.81,0.637,1.624,0.637,2.441v32.711c0,0.768-0.183,1.526-0.541,2.276 c-0.03,0.072-0.063,0.143-0.1,0.213c-0.325,0.626-0.786,1.251-1.377,1.877c-0.597,0.634-1.215,1.137-1.857,1.502 c-0.835,0.475-1.688,0.717-2.563,0.717H6.307L6.307,104.918z M26.616,33.322c-2.49,0-4.78-0.368-6.874-1.106 c-2.141-0.755-4.043-1.891-5.709-3.41c-0.048-0.043-0.094-0.088-0.138-0.134c-1.639-1.506-2.87-3.251-3.699-5.231 c-0.845-2.019-1.264-4.249-1.264-6.683c0-2.435,0.419-4.68,1.266-6.725c0.857-2.073,2.133-3.891,3.835-5.444l0.044-0.04 c1.646-1.512,3.529-2.649,5.654-3.414C21.839,0.377,24.133,0,26.616,0c2.54,0,4.867,0.373,6.982,1.124 c2.163,0.768,4.077,1.922,5.745,3.466l0.001-0.001c1.701,1.552,2.978,3.371,3.835,5.443c0.846,2.045,1.266,4.291,1.266,6.726 c0,2.434-0.419,4.665-1.265,6.684c-0.853,2.036-2.13,3.825-3.841,5.36l0.005,0.004c-1.665,1.518-3.584,2.653-5.758,3.41 C31.465,32.954,29.143,33.322,26.616,33.322L26.616,33.322z M21.691,26.691c1.442,0.508,3.083,0.762,4.925,0.762 c1.902,0,3.584-0.253,5.045-0.762c1.409-0.49,2.655-1.229,3.74-2.218l0.005,0.005l0.018-0.017c1.047-0.936,1.827-2.026,2.347-3.267 c0.539-1.287,0.806-2.768,0.806-4.437c0-1.694-0.267-3.197-0.807-4.502c-0.518-1.252-1.306-2.366-2.368-3.335l0.001-0.001 l-0.023-0.021c-1.077-1-2.319-1.75-3.729-2.25c-1.469-0.521-3.146-0.78-5.034-0.78c-1.849,0-3.486,0.255-4.914,0.769 c-1.361,0.489-2.578,1.227-3.654,2.215c-0.024,0.023-0.048,0.046-0.073,0.068c-1.062,0.97-1.85,2.083-2.368,3.335 c-0.54,1.305-0.807,2.808-0.807,4.501c0,1.669,0.268,3.149,0.806,4.437c0.498,1.19,1.237,2.242,2.219,3.151 c0.051,0.041,0.101,0.083,0.15,0.128C19.059,25.461,20.297,26.199,21.691,26.691L21.691,26.691z"/></svg></button>
    </div>
    <div class="video-menu">
      <div class="settings-wrap">
        <button class="btn-settings" id="btn-settings" title="Meny"><svg width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="5" x2="17" y2="5"/><line x1="3" y1="10" x2="17" y2="10"/><line x1="3" y1="15" x2="17" y2="15"/></svg></button>
        <div class="settings-menu" id="settings-menu">
          <button class="settings-item" id="btn-about">Om SignFlash...</button>
          <button class="settings-item" id="btn-show-stats">Statistik</button>
          <button class="settings-item danger" id="btn-reset-progress">Nollst√§ll framsteg</button>
        </div>
      </div>
    </div>
    <div class="video-controls">
      <button class="btn-icon" id="btn-face" title="Zoom in on face"><svg width="20" height="20" viewBox="0 0 97.49 122.88" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M7.33,70.92c.89-2.48,2-3.81,3.38-4.37-.62-11.77,1.36-30.39-10.71-34C23.84,3.05,51.32-13,72,13.23c23.71,1.25,33.87,37.24,17.56,55a6.34,6.34,0,0,1,3.23.75,5.52,5.52,0,0,1,2.66,3.35,10.74,10.74,0,0,1-.2,6l-.07.23c-.3.88-.56,2-.83,3.16-1.09,4.73-2.29,9.94-7.69,9.65a6.11,6.11,0,0,1-.86-.09c-.2,9.81-5,14.32-11.28,20.21-.8.75-1.62,1.53-2.41,2.29-6.35,6.13-13.29,9.09-20.35,9.1s-14.37-3.07-21-9c-1-.9-1.69-1.49-2.35-2.06-6.15-5.29-11.29-9.72-12.27-20.5h-.54a7.39,7.39,0,0,1-3.62-.95C9.37,88.94,8,86.21,7.34,83.09a36.14,36.14,0,0,1-.16-11.61,2.56,2.56,0,0,1,.15-.56ZM68.77,35.29c-5.44,5.48-11.2,7.06-16.84,7.55-1.66.3-3.28.5-4.9.7-5.41.66-10.81,1.33-18,6.28a17.27,17.27,0,0,0-6.82,8.52A21.39,21.39,0,0,0,22,70a2.29,2.29,0,0,1-.05,1.46,2.37,2.37,0,0,1-3,1.41l-2.73-1c-2.24-.78-3.63-1-4.3.55A31.31,31.31,0,0,0,12,82.11c.41,1.91,1.11,3.5,2.26,4.15a2.7,2.7,0,0,0,1.34.34,6.49,6.49,0,0,0,1.94-.32,2.34,2.34,0,0,1,.7-.12,2.37,2.37,0,0,1,2.42,2.3c.26,10.71,5,14.8,10.79,19.78.89.77,1.8,1.55,2.41,2.09,5.8,5.17,11.91,7.83,17.9,7.83,5.82,0,11.64-2.54,17.07-7.78.88-.85,1.68-1.6,2.45-2.33,6.06-5.69,10.53-9.89,9.67-20.11a2.37,2.37,0,0,1,3.66-2.17,6,6,0,0,0,1.27.66,3.56,3.56,0,0,0,1,.23c1.44.07,2.18-3.11,2.84-6,.3-1.28.59-2.53,1-3.62a6.43,6.43,0,0,0,.24-3.34,1,1,0,0,0-.42-.59A2.22,2.22,0,0,0,89.27,73a8.35,8.35,0,0,0-4,1.78,2.34,2.34,0,0,1-1.83.44,2.37,2.37,0,0,1-1.93-2.73c2.23-13,1.21-21.47-1.56-27.25-2.43-5.06-6.3-8.13-10.5-10.42l-.67.51Zm-24.48,25c2.54.95,3.08,3.07,1.66,3.87-1.67.94-3.77-.46-5.4-1-4.25-1.35-9.3-1.51-13,.78a20.07,20.07,0,0,0-3,2.36,10.2,10.2,0,0,1,1.81-3.64c3.68-4.64,12.95-4.92,17.87-2.39ZM31.07,69.42a1,1,0,0,1-1.33-.75,1.24,1.24,0,0,1,.65-1.51,17.5,17.5,0,0,1,12.66,0,1.23,1.23,0,0,1,.68,1.49,1,1,0,0,1-1.3.77,20.75,20.75,0,0,0-2.09-.63,2.93,2.93,0,1,1-5.75.78,2.76,2.76,0,0,1,.22-1.12,15.18,15.18,0,0,0-3.74,1Zm27.17-9.11c-2.54.95-3.07,3.07-1.65,3.87,1.67.94,3.77-.46,5.39-1,4.25-1.35,9.29-1.51,13,.78a21.15,21.15,0,0,1,3,2.36,10.54,10.54,0,0,0-1.81-3.64c-3.69-4.64-13-4.92-17.88-2.39ZM63,68.53a3.05,3.05,0,0,0-.2,1,2.94,2.94,0,1,0,5.57-1.29,19.8,19.8,0,0,1,3.87.85,1,1,0,0,0,1.29-.82,1.23,1.23,0,0,0-.72-1.47,20.3,20.3,0,0,0-6.33-1,19.66,19.66,0,0,0-6.26,1,1.22,1.22,0,0,0-.71,1.47,1,1,0,0,0,1.29.81,20.6,20.6,0,0,1,2.2-.6ZM46.38,92.28a1.77,1.77,0,1,1,2.28-2.72,4.07,4.07,0,0,0,2.56,1.14,4.18,4.18,0,0,0,2.68-1.16,1.77,1.77,0,0,1,2.25,2.73,7.7,7.7,0,0,1-5,2,7.28,7.28,0,0,1-4.79-2Zm-5.31,11A1.86,1.86,0,1,1,42.81,100a18.18,18.18,0,0,0,8.51,2.32,17.09,17.09,0,0,0,8.37-2.3,1.87,1.87,0,0,1,1.81,3.27A20.45,20.45,0,0,1,51.34,106a22,22,0,0,1-10.27-2.75Z"/></svg></button>
      <button class="btn-icon" id="btn-slow" title="Normal speed"><svg width="20" height="20" viewBox="0 0 431.347 431.347" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M60.177,103.279v-18h17.564v18H60.177z M195.34,310.388c-12.314-17.736-36.526-49.441-60.314-62.499c-21.169-11.621-34.072-3.648-39.881,2.138l12.705,12.751c2.254-2.247,5.523-4.211,12.662-1.757c14.05,4.827,33.989,23.833,54.706,52.146c14.808,20.237,24.831,38.142,28.947,47.45c-10.541,1.535-25.629-0.151-41.676-4.841c-22.353-6.534-42.723-17.648-55.888-30.492c-14.992-14.627-19.483-29.964-13.35-45.585l2.325-5.92l-4.805-4.168c-16.492-14.305-24.906-30.681-25.007-48.673l-0.41-73.931h-8.95C35.229,147.005,18,129.776,18,108.6c0-21.176,17.229-38.405,38.405-38.405h23.701c8.845,0,14.106,7.764,14.733,15.437c0.111,1.366,0.122,3.688,0.133,6.145c0.052,11.392,0.123,26.993,7.953,35.816l13.463-11.948c-3.324-3.745-3.389-17.903-3.416-23.949c-0.013-2.938-0.024-5.474-0.193-7.53c-1.487-18.226-15.533-31.97-32.673-31.97H56.405C25.304,52.195,0,77.498,0,108.6c0,28.055,20.59,51.392,47.451,55.695l0.314,56.742c0.12,21.315,9.339,41.285,26.74,58.08c-5.563,20.448,1.234,41.203,19.526,59.049c15.206,14.835,38.316,27.551,63.407,34.885c13.872,4.055,26.937,6.101,38.207,6.101c8.977,0,16.815-1.298,23.016-3.911l4.292-1.809l1.002-4.548c0.738-3.352,0.807-8.298-7.786-24.665C210.85,334.086,203.452,322.07,195.34,310.388z M317.151,276.567c-9.628-3.972-23.822-6.079-34.781-0.089c-6.743,3.686-11.061,9.793-12.485,17.663l17.711,3.208c0.447-2.467,1.498-4.032,3.406-5.076c4.243-2.319,12.354-1.926,19.286,0.934c23.851,9.838,49.97,47.685,58.715,65.336c-21.86-0.602-56.692-9.203-74.321-24.043c-6.542-5.507-9.923-11.23-10.051-17.011l-0.151-6.817l-6.603-1.7c-10.733-2.764-43.312-6.911-64.873,6.895l9.705,15.159c12.381-7.927,32.896-7.559,44.891-5.756c2.028,8.324,7.215,16.035,15.49,23.001c22.309,18.779,63.577,28.252,88.795,28.251c3.884,0,7.391-0.225,10.385-0.675l6.119-0.92l1.332-6.043c2.563-11.627-16.183-38.507-21.989-46.469C357.999,309.07,338.485,285.367,317.151,276.567z M429.473,219.554c-9.41,31.17-31.051,56.212-68.094,78.796l-9.369-15.369c26.69-16.272,44.311-33.632,54.342-53.771c-57.392,10.891-134.155,11.81-158.058,11.81c-55.169,0-109.044-6.086-155.803-17.602l-6.188-1.524l-0.618-6.342c-0.305-3.128-0.459-6.282-0.459-9.372c0-33.767,17.305-65.342,48.726-88.907c30.646-22.985,71.254-35.643,114.342-35.643c78.001,0,145.128,42.18,160.02,100.416c0.938,0.727,3.139,1.851,4.656,2.625C420.716,188.624,436.821,196.841,429.473,219.554z M123.917,211.837c1.899-16.608,8.691-33.886,19.649-49.651c10.612-15.269,24.015-27.674,37.469-34.829V111.79c-46.214,17.838-77.809,53.457-77.809,94.391c0,0.432,0.004,0.865,0.011,1.3C109.99,209.047,116.893,210.5,123.917,211.837z M239.294,222.964l-0.002-51.875l-48.962-28.27c-20.266,10.445-45.607,40.264-48.656,72.106C172.617,219.818,205.625,222.55,239.294,222.964z M297.551,127.06v-21.068c-15.683-4.175-32.345-6.362-49.257-6.362c-17.283,0-33.874,2.232-49.259,6.324v21.107l49.257,28.44L297.551,127.06z M360.417,217.54c-3.834-30.818-31.886-63.651-53.465-75.123l-49.66,28.672l0.002,51.894C289.097,222.728,326.513,221.115,360.417,217.54z M404.788,200.704c-5.304-2.707-11.904-6.075-13.749-13.548c-5.905-23.911-23.124-45.881-48.484-61.865c-8.34-5.256-17.405-9.761-27.004-13.463v14.795c25.711,13.885,58.102,50.938,62.744,88.798c12.668-1.684,24.548-3.685,35.09-6.04C413.619,205.41,411.041,203.895,404.788,200.704z"/></svg></button>
    </div>
  </div>

  <div class="phrase-text" id="phrase-text"></div>

  <div class="input-row">
    <input type="text" id="answer-input" placeholder="Skriv ordet..." autocomplete="off" autocapitalize="none" spellcheck="false">
    <button class="btn btn-submit" id="btn-submit">OK</button>
    <button class="btn btn-alt" id="btn-show-alt">?</button>
  </div>

  <div class="alternatives" id="alternatives"></div>

  <div class="feedback" id="feedback"></div>
</div>

<div class="stats-overlay" id="about-overlay">
  <div class="stats-header">
    <h2>Om SignFlash</h2>
    <button class="btn-close-stats" id="btn-close-about">&times;</button>
  </div>
  <div style="padding: 20px; line-height: 1.8; color: #ccc; font-size: 15px;">
    <p style="margin-bottom:12px;">‚ö° Tr√§na Svenskt Teckenspr√•k med flashcards!</p>
    <p>üé¨ titta p√• videon &nbsp;‚úèÔ∏è skriv tecknet &nbsp;‚úÖ forts√§tt tills du kan det!</p>
    <p>‚ùì svarar du fel f√•r du 4 alternativ att v√§lja p√•</p>
    <p>‚≠ê‚≠ê‚≠ê tre r√§tt i rad utan hj√§lp &nbsp;üéâ tecknet √§r "klart"</p>
    <p style="margin-bottom:12px;">üìö ordlistor i olika kategorier, med exempelfraser</p>
    <p>üê¢ olika uppspelningshastigheter (1√ó, 0.5√ó, 0.25√ó)</p>
    <p style="margin-bottom:12px;">üÜì helt fritt, ingen inloggning ‚Äî framsteg sparas i browsern</p>
    <p style="margin-bottom:12px;">üí° p√• mobiltelefon: v√§lj <em>L√§gg till p√• hemsk√§rmen</em> f√∂r att k√∂ra som app</p>
    <p>üé• videor fr√•n <a href="https://teckensprakslexikon.su.se" target="_blank" rel="noopener" style="color:#818cf8;">Teckenspr√•kslexikon</a>, Stockholms universitet</p>
    <p style="margin-top:16px;">üíö Vibekodat med k√§rlek av <a href="https://github.com/jbeskow" target="_blank" rel="noopener" style="color:#818cf8;">jbeskow</a> &nbsp;
      <a href="https://github.com/jbeskow/signflash" target="_blank" rel="noopener" style="color:#818cf8;"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:text-bottom;margin-right:3px;"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>GitHub</a>
    </p>
  </div>
</div>

<div class="stats-overlay" id="stats-overlay">
  <div class="stats-header">
    <h2>Statistik</h2>
    <button class="btn-close-stats" id="btn-close-stats">&times;</button>
  </div>
  <div class="stats-list" id="stats-list"></div>
</div>

<div class="completion-overlay" id="completion-overlay">
  <div class="completion-stars"><span>&#x2B50;</span><span>&#x2B50;</span><span>&#x2B50;</span></div>
  <div class="completion-title">Alla ord klara!</div>
  <div class="completion-subtitle" id="completion-subtitle"></div>
  <button class="btn-completion-close" id="btn-completion-close">Forts√§tt</button>
</div>

<script src="lists/all.js"></script>
<script>
(function() {
  "use strict";

  const SETTINGS_KEY = "signflash_settings";
  const FEEDBACK_DELAY = 1800;
  const MASTERY_DELAY = 2500;

  const DEFAULT_WORDLIST = "allmant1";
  let savedWl = loadSettings().wordlistId;
  let currentWordlistId = window.WORDLISTS.find(w => w.id === savedWl) ? savedWl
    : window.WORDLISTS.find(w => w.id === DEFAULT_WORDLIST) ? DEFAULT_WORDLIST
    : window.WORDLISTS[0].id;

  function getCurrentWordlist() {
    return window.WORDLISTS.find(w => w.id === currentWordlistId) || window.WORDLISTS[0];
  }

  // --- Phrase lookup (recomputed on wordlist change) ---

  let phrasesByWord = {};
  let phraseWordList = [];

  function recomputePhrases() {
    phrasesByWord = {};
    const wl = getCurrentWordlist();
    const phraseSource = (wl.phrases && wl.phrases.length > 0)
      ? wl.phrases
      : (typeof PHRASELIST !== 'undefined' ? PHRASELIST : []);
    const wordSet = new Set(wl.words.map(w => w.word));
    for (const p of phraseSource) {
      if (!wordSet.has(p.word)) continue;
      if (!phrasesByWord[p.word]) phrasesByWord[p.word] = [];
      phrasesByWord[p.word].push(p);
    }
    phraseWordList = Object.keys(phrasesByWord).map(w => ({ word: w }));
    // NOTE: do NOT manipulate btnModePhrase here ‚Äî called before it's declared
  }

  recomputePhrases();

  // --- Progress migration ---

  function migrateProgress() {
    const oldKey = "signflash_progress";
    const oldPhraseKey = "signflash_phrase_progress";
    const newKey = "signflash_progress_blandat1";
    const newPhraseKey = "signflash_phrase_progress_blandat1";

    if (localStorage.getItem(oldKey) && !localStorage.getItem(newKey)) {
      localStorage.setItem(newKey, localStorage.getItem(oldKey));
    }
    if (localStorage.getItem(oldPhraseKey) && !localStorage.getItem(newPhraseKey)) {
      localStorage.setItem(newPhraseKey, localStorage.getItem(oldPhraseKey));
    }
  }

  migrateProgress();

  function loadSettings() {
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; } catch { return {}; }
  }
  function saveSettings(s) { localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }
  function getMasteryStreak() { return loadSettings().masteryStreak || 3; }

  const video = document.getElementById("sign-video");
  const videoSource = document.getElementById("video-source");
  const answerInput = document.getElementById("answer-input");
  const btnSubmit = document.getElementById("btn-submit");
  const btnShowAlt = document.getElementById("btn-show-alt");
  const btnSlow = document.getElementById("btn-slow");
  const btnFace = document.getElementById("btn-face");
  let slowMode = 0; // 0=1x  1=0.5x  2=0.25x
  const slowRates = [1, 0.5, 0.25];
  const alternativesDiv = document.getElementById("alternatives");
  const feedbackDiv = document.getElementById("feedback");
  const phraseTextDiv = document.getElementById("phrase-text");
  const btnModeWord = document.getElementById("btn-mode-word");
  const btnModePhrase = document.getElementById("btn-mode-phrase");

  const MIN_GAP = 6;
  let currentItem = null;
  let currentPhrase = null;
  let recentWords = [];
  let usedAlternatives = false;
  let waitingForNext = false;
  let currentMode = "word";

  // --- Mode & storage keys ---

  function getStorageKey() {
    const base = currentMode === "phrase"
      ? "signflash_phrase_progress"
      : "signflash_progress";
    return base + "_" + currentWordlistId;
  }

  function getWordList() {
    return currentMode === "phrase" ? phraseWordList : getCurrentWordlist().words;
  }

  function setMode(mode) {
    if (mode === currentMode) return;
    currentMode = mode;
    recentWords = [];
    btnModeWord.classList.toggle("active", mode === "word");
    btnModePhrase.classList.toggle("active", mode === "phrase");
    answerInput.placeholder = mode === "phrase" ? "Skriv ordet som saknas..." : "Skriv ordet...";
    updateProgressDisplay();
    nextRound();
  }

  function updatePhraseBtnState() {
    const hasPhrase = phraseWordList.length > 0;
    btnModePhrase.disabled = !hasPhrase;
    btnModeWord.classList.toggle("active", currentMode === "word");
    btnModePhrase.classList.toggle("active", currentMode === "phrase");
  }

  btnModeWord.addEventListener("click", () => setMode("word"));
  btnModePhrase.addEventListener("click", () => setMode("phrase"));

  // --- Progress persistence ---

  function loadProgress() {
    try {
      return JSON.parse(localStorage.getItem(getStorageKey())) || {};
    } catch { return {}; }
  }

  function saveProgress(progress) {
    localStorage.setItem(getStorageKey(), JSON.stringify(progress));
  }

  function getStats(word, progress) {
    return progress[word] || { correct: 0, incorrect: 0, assisted: 0, streak: 0, lastSeen: 0 };
  }

  // --- Word categorization ---

  function categorize(progress) {
    const wordList = getWordList();
    const unseen = [], struggling = [], assistedOnly = [], learning = [], mastered = [];

    for (const item of wordList) {
      const s = getStats(item.word, progress);
      const total = s.correct + s.incorrect + s.assisted;

      if (total === 0) {
        unseen.push(item);
        continue;
      }

      const streak = s.streak || 0;

      if (streak >= getMasteryStreak()) {
        mastered.push(item);
      } else if (s.correct === 0 && s.incorrect === 0 && s.assisted > 0) {
        assistedOnly.push(item);
      } else if (s.incorrect > s.correct) {
        struggling.push(item);
      } else {
        learning.push(item);
      }
    }

    return { unseen, struggling, assistedOnly, learning, mastered };
  }

  // Helper: count mastered for any wordlist id (used by dropdown)
  function countMastered(wlId) {
    const wl = window.WORDLISTS.find(w => w.id === wlId);
    if (!wl) return { mastered: 0, total: 0 };
    const key = "signflash_progress_" + wlId;
    let progress = {};
    try { progress = JSON.parse(localStorage.getItem(key)) || {}; } catch {}
    let mastered = 0;
    for (const item of wl.words) {
      const s = progress[item.word];
      if (s && (s.streak || 0) >= getMasteryStreak()) mastered++;
    }
    return { mastered, total: wl.words.length };
  }

  // --- Word selection ---

  function pickFromBucket(bucket, progress) {
    if (bucket.length === 0) return null;
    bucket.sort((a, b) => {
      const sa = getStats(a.word, progress).lastSeen;
      const sb = getStats(b.word, progress).lastSeen;
      return sa - sb;
    });
    const pool = bucket.slice(0, Math.max(3, Math.ceil(bucket.length / 4)));
    return pool[Math.floor(Math.random() * pool.length)];
  }

  function selectWord() {
    const wordList = getWordList();
    const progress = loadProgress();
    const cats = categorize(progress);

    const buckets = [
      { items: cats.struggling, weight: 35 },
      { items: cats.assistedOnly, weight: 25 },
      { items: cats.unseen, weight: 25 },
      { items: cats.learning, weight: 15 },
    ];

    const recentSet = new Set(recentWords);
    const filterRecent = (arr) => arr.filter(i => !recentSet.has(i.word));

    let totalWeight = 0;
    const available = [];
    for (const b of buckets) {
      const filtered = filterRecent(b.items);
      if (filtered.length > 0) {
        available.push({ items: filtered, weight: b.weight });
        totalWeight += b.weight;
      }
    }

    if (available.length === 0) {
      const unmastered = wordList.filter(i => {
        const s = getStats(i.word, progress);
        return (s.streak || 0) < getMasteryStreak();
      });
      if (unmastered.length > 0) {
        return unmastered[Math.floor(Math.random() * unmastered.length)];
      }
      return wordList[Math.floor(Math.random() * wordList.length)];
    }

    let roll = Math.random() * totalWeight;
    for (const b of available) {
      roll -= b.weight;
      if (roll <= 0) {
        return pickFromBucket(b.items, progress);
      }
    }

    return pickFromBucket(available[available.length - 1].items, progress);
  }

  // --- Phrase blanking ---

  function blankPhrase(phrase) {
    const blanked = phrase.replace(/\[[^\]]+\]/g, "___");
    if (blanked === phrase) return phrase + " ___";
    return blanked;
  }

  // --- Alternatives ---

  function getDistractors(correctWord, count) {
    const others = getCurrentWordlist().words.filter(i => i.word !== correctWord);
    const shuffled = others.slice().sort(() => Math.random() - 0.5);
    return shuffled.slice(0, count).map(i => i.word);
  }

  function showAlternatives() {
    usedAlternatives = true;
    const correct = currentItem.word;
    const distractors = getDistractors(correct, 3);
    const options = [correct, ...distractors].sort(() => Math.random() - 0.5);

    alternativesDiv.innerHTML = "";
    for (const opt of options) {
      const btn = document.createElement("button");
      btn.className = "alt-btn";
      btn.textContent = opt;
      btn.addEventListener("click", () => {
        answerInput.value = opt;
        checkAnswer();
      });
      alternativesDiv.appendChild(btn);
    }
    alternativesDiv.classList.add("visible");
    btnShowAlt.style.display = "none";
  }

  // --- Answer checking ---

  let pendingIncorrect = false;

  function checkAnswer() {
    if (waitingForNext) return;

    const answer = answerInput.value.trim().toLowerCase();
    if (!answer) return;

    const correct = currentItem.word.toLowerCase();
    let accepted = [correct];
    if (currentMode === "phrase" && currentPhrase) {
      const bracketed = currentPhrase.phrase.match(/\[([^\]]+)\]/g);
      if (bracketed) {
        for (const b of bracketed) {
          accepted.push(b.slice(1, -1).toLowerCase());
        }
      }
    }
    const isCorrect = accepted.includes(answer);

    if (isCorrect) {
      const progress = loadProgress();
      const stats = getStats(currentItem.word, progress);
      const unassisted = !usedAlternatives && !pendingIncorrect;
      if (unassisted) {
        stats.correct++;
        stats.streak = (stats.streak || 0) + 1;
      } else {
        stats.assisted++;
        stats.streak = 0;
      }
      stats.lastSeen = Date.now();
      progress[currentItem.word] = stats;
      saveProgress(progress);
      const justMastered = unassisted && stats.streak === getMasteryStreak();
      pendingIncorrect = false;
      showFeedback(true, currentItem.word, stats.streak, justMastered);
      updateProgressDisplay();
      if (justMastered) {
        const cats = categorize(progress);
        const masteredCount = cats.mastered.length;
        setTimeout(pulseCounter, 500);
        // Check completion
        if (masteredCount === getWordList().length) {
          setTimeout(() => showCompletion(), 600);
        } else if (masteredCount % 10 === 0) {
          setTimeout(() => showMilestone(masteredCount), 600);
        }
      }
    } else {
      const progress = loadProgress();
      const stats = getStats(currentItem.word, progress);
      stats.incorrect++;
      stats.streak = 0;
      stats.lastSeen = Date.now();
      progress[currentItem.word] = stats;
      saveProgress(progress);
      pendingIncorrect = true;
      updateProgressDisplay();
      answerInput.blur();
      setTimeout(scrollToTop, 100);
      showAlternatives();
    }
  }

  const isTouch = "ontouchstart" in window;

  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function focusInput() {
    if (!isTouch) answerInput.focus();
  }

  function pulseCounter() {
    const el = document.getElementById("stat-mastered");
    el.classList.remove("pulse");
    void el.offsetWidth;
    el.classList.add("pulse");
  }

  const milestonePool = [
    (n, m) => n + " " + m + " klara ‚Äî snyggt jobbat!",
    (n, m) => n + " " + m + " i hamn, k√∂r p√•!",
    (n, m) => "Kanonbra ‚Äî " + n + " " + m + " klara!",
    (n, m) => n + " " + m + " mastrade, imponerande!",
    (n, m) => "Str√•lande ‚Äî " + n + " " + m + " klara!",
    (n, m) => n + " " + m + " ner, h√•ll i!",
    (n, m) => "Bra k√§mpat ‚Äî " + n + " " + m + " klara!",
    (n, m) => n + " " + m + "? Du √§r p√• r√§tt sp√•r!",
    (n, m) => "Forts√§tt s√• ‚Äî " + n + " " + m + " klara!",
    (n, m) => n + " " + m + " klara, fenomenalt!",
    (n, m) => "Wow ‚Äî " + n + " " + m + " redan!",
    (n, m) => n + " " + m + " avklarade, du √§r grym!",
  ];

  function showMilestone(count) {
    const el = document.createElement("div");
    el.className = "milestone";
    const mode = currentMode === "phrase" ? "fraser" : "ord";
    const fn = milestonePool[Math.floor(Math.random() * milestonePool.length)];
    el.textContent = fn(count, mode);
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2600);
  }

  // --- Completion overlay ---

  const completionOverlay = document.getElementById("completion-overlay");
  const completionSubtitle = document.getElementById("completion-subtitle");
  const btnCompletionClose = document.getElementById("btn-completion-close");

  function spawnConfetti() {
    const colors = ["#4ecca3", "#f0c040", "#e74c3c", "#818cf8", "#fb923c", "#38bdf8", "#f472b6"];
    for (let i = 0; i < 80; i++) {
      const el = document.createElement("div");
      const angle = Math.random() * Math.PI * 2;
      const dist = 130 + Math.random() * 230;
      const size = 5 + Math.random() * 7;
      el.style.position = "fixed";
      el.style.width = size + "px";
      el.style.height = (size * (0.4 + Math.random())) + "px";
      el.style.background = colors[Math.floor(Math.random() * colors.length)];
      el.style.left = "calc(50% + " + ((Math.random() - 0.5) * 100) + "px)";
      el.style.top = "42%";
      el.style.borderRadius = Math.random() > 0.55 ? "50%" : "2px";
      el.style.pointerEvents = "none";
      el.style.zIndex = "400";
      el.style.setProperty("--cx", (Math.cos(angle) * dist) + "px");
      el.style.setProperty("--cy", (Math.sin(angle) * dist - 80) + "px");
      el.style.setProperty("--cr", ((Math.random() - 0.5) * 900) + "deg");
      el.style.animation = "confetti-fly " + (0.7 + Math.random() * 1.1) + "s cubic-bezier(0.2,0.8,0.3,1) " + (Math.random() * 0.35) + "s forwards";
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2200);
    }
  }

  function showCompletion() {
    const wl = getCurrentWordlist();
    completionSubtitle.textContent = wl.name + " ‚Äî alla " + wl.words.length + " ord klara!";
    // Re-trigger star animations
    completionOverlay.querySelectorAll(".completion-stars span").forEach(s => {
      s.style.animation = "none";
      s.offsetHeight; // reflow
      s.style.animation = "";
    });
    completionOverlay.classList.add("open");
    spawnConfetti();
    renderWordlistDropdown();
  }

  btnCompletionClose.addEventListener("click", () => {
    completionOverlay.classList.remove("open");
  });

  function makeStars(streak) {
    const target = getMasteryStreak();
    const clamped = Math.min(streak, target);
    let stars = "";
    for (let i = 0; i < target; i++) {
      stars += i < clamped ? "&#x2605;" : "&#x2606;";
    }
    return stars;
  }

  function showFeedback(isCorrect, correctWord, streak, justMastered) {
    waitingForNext = true;
    answerInput.blur();
    answerInput.disabled = true;
    btnSubmit.disabled = true;
    btnShowAlt.disabled = true;

    feedbackDiv.className = "feedback";

    if (isCorrect) {
      if (justMastered) {
        feedbackDiv.classList.add("correct", "mastered-celebration");
      } else {
        feedbackDiv.classList.add("correct");
      }
      let html = escapeHtml(correctWord)
        + ' <span class="streak-stars">' + makeStars(streak) + "</span>";
      if (currentMode === "phrase" && currentPhrase) {
        const filled = currentPhrase.phrase.replace(/\[([^\]]+)\]/g,
          function(_, m) { return '<span style="color:#4ecca3;font-weight:700">' + escapeHtml(m) + '</span>'; }
        );
        html = '<div style="font-size:15px;margin-bottom:8px;font-weight:400;color:#ccc">' + filled + '</div>' + html;
      }
      feedbackDiv.innerHTML = html;
    } else {
      feedbackDiv.classList.add("incorrect");
      feedbackDiv.innerHTML = escapeHtml(correctWord)
        + ' <span class="streak-stars">' + makeStars(0) + "</span>";
    }

    setTimeout(scrollToTop, 100);
    const delay = justMastered ? MASTERY_DELAY : FEEDBACK_DELAY;
    setTimeout(nextRound, delay);
  }

  function escapeHtml(s) {
    const d = document.createElement("div");
    d.textContent = s;
    return d.innerHTML;
  }

  // --- Round management ---

  function nextRound() {
    waitingForNext = false;
    usedAlternatives = false;
    pendingIncorrect = false;

    feedbackDiv.className = "feedback";
    feedbackDiv.innerHTML = "";
    alternativesDiv.classList.remove("visible");
    alternativesDiv.innerHTML = "";
    btnShowAlt.style.display = "";

    answerInput.value = "";
    answerInput.disabled = false;
    btnSubmit.disabled = false;
    btnShowAlt.disabled = false;

    if (currentItem) {
      recentWords.push(currentItem.word);
      if (recentWords.length > MIN_GAP) recentWords.shift();
    }

    const selected = selectWord();

    if (currentMode === "phrase") {
      const phrases = phrasesByWord[selected.word];
      currentPhrase = phrases[Math.floor(Math.random() * phrases.length)];
      currentItem = { word: selected.word, video: currentPhrase.video };
      phraseTextDiv.textContent = blankPhrase(currentPhrase.phrase);
      phraseTextDiv.style.display = "block";
    } else {
      currentItem = selected;
      currentPhrase = null;
      phraseTextDiv.style.display = "none";
    }

    const idMatch = currentItem.video.match(/-(\d{5})-/);
    const prefix = idMatch ? idMatch[1].substring(0, 2) : "00";
    videoSource.src = "https://teckensprakslexikon.su.se/movies/" + prefix + "/" + currentItem.video;
    video.load();
    video.playbackRate = slowRates[slowMode];
    video.play().catch(() => {});

    scrollToTop();
    focusInput();
  }

  // --- Progress display ---

  function updateProgressDisplay() {
    const progress = loadProgress();
    const cats = categorize(progress);
    const total = getWordList().length;

    document.getElementById("stat-mastered").textContent = "Klara: " + cats.mastered.length;
    document.getElementById("stat-learning").textContent =
      "L√§r sig: " + (cats.struggling.length + cats.assistedOnly.length + cats.learning.length);
    document.getElementById("stat-unseen").textContent = "Nya: " + cats.unseen.length;

    const masteredPct = (cats.mastered.length / total) * 100;
    const learningPct = ((total - cats.mastered.length - cats.unseen.length) / total) * 100;

    document.getElementById("progress-mastered").style.width = masteredPct + "%";
    document.getElementById("progress-learning").style.width = learningPct + "%";

    // Update wordlist button count
    const info = countMastered(currentWordlistId);
    document.getElementById("wordlist-btn-count").textContent = "(" + info.mastered + "/" + info.total + ")";
  }

  // --- Wordlist selector ---

  const wordlistBtn = document.getElementById("wordlist-btn");
  const wordlistMenu = document.getElementById("wordlist-menu");

  function renderWordlistDropdown() {
    document.getElementById("wordlist-btn-name").textContent = getCurrentWordlist().name;
    const info = countMastered(currentWordlistId);
    document.getElementById("wordlist-btn-count").textContent = "(" + info.mastered + "/" + info.total + ")";

    let html = "";
    for (const wl of window.WORDLISTS) {
      const m = countMastered(wl.id);
      const isActive = wl.id === currentWordlistId;
      const isComplete = m.mastered === m.total;
      html += '<button class="wordlist-menu-item' + (isActive ? ' active' : '') + '" data-wl-id="' + escapeHtml(wl.id) + '">'
        + '<span class="wl-check">' + (isComplete ? "\u2713" : "") + '</span>'
        + '<span class="wl-name">' + escapeHtml(wl.name) + '</span>'
        + '<span class="wl-count">(' + m.mastered + '/' + m.total + ')</span>'
        + '</button>';
    }
    wordlistMenu.innerHTML = html;

    // Bind click handlers
    for (const btn of wordlistMenu.querySelectorAll(".wordlist-menu-item")) {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-wl-id");
        switchWordlist(id);
        wordlistMenu.classList.remove("open");
      });
    }
  }

  function switchWordlist(id) {
    if (id === currentWordlistId) return;
    currentWordlistId = id;
    const s = loadSettings(); s.wordlistId = id; saveSettings(s);
    recentWords = [];
    recomputePhrases();
    if (currentMode === "phrase" && phraseWordList.length === 0) {
      currentMode = "word";
      answerInput.placeholder = "Skriv ordet...";
    }
    updatePhraseBtnState();
    renderWordlistDropdown();
    updateProgressDisplay();
    nextRound();
  }

  wordlistBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    renderWordlistDropdown();
    wordlistMenu.classList.toggle("open");
  });

  document.addEventListener("click", () => {
    wordlistMenu.classList.remove("open");
  });

  wordlistMenu.addEventListener("click", (e) => {
    e.stopPropagation();
  });

  // --- Settings menu ---

  const btnSettings = document.getElementById("btn-settings");
  const settingsMenu = document.getElementById("settings-menu");
  const btnResetProgress = document.getElementById("btn-reset-progress");

  btnSettings.addEventListener("click", (e) => {
    e.stopPropagation();
    settingsMenu.classList.toggle("open");
  });

  document.addEventListener("click", () => {
    settingsMenu.classList.remove("open");
  });

btnResetProgress.addEventListener("click", () => {
    const label = currentMode === "phrase" ? "frasframsteg" : "alla framsteg";
    if (confirm("Nollst√§ll " + label + "? Detta kan inte √•ngras.")) {
      localStorage.removeItem(getStorageKey());
      updateProgressDisplay();
      renderWordlistDropdown();
      nextRound();
    }
  });

  // --- Stats overlay ---

  const statsOverlay = document.getElementById("stats-overlay");
  const statsList = document.getElementById("stats-list");
  const btnShowStats = document.getElementById("btn-show-stats");
  const btnCloseStats = document.getElementById("btn-close-stats");

  function renderStats() {
    const progress = loadProgress();
    const cats = categorize(progress);

    const mastered = cats.mastered.map(i => ({ word: i.word, ...getStats(i.word, progress) }));
    const inProgress = [...cats.struggling, ...cats.assistedOnly, ...cats.learning]
      .map(i => ({ word: i.word, ...getStats(i.word, progress) }));

    mastered.sort((a, b) => a.word.localeCompare(b.word, "sv"));
    inProgress.sort((a, b) => a.word.localeCompare(b.word, "sv"));

    const emptyLabel = currentMode === "phrase" ? "fraser" : "ord";
    let html = "";

    html += '<div class="stats-section-title mastered">Klara (' + mastered.length + ')</div>';
    if (mastered.length === 0) {
      html += '<div class="stats-empty">Inga ' + emptyLabel + ' klara √§nnu</div>';
    }
    for (const s of mastered) {
      html += statsRowHtml(s);
    }

    html += '<div class="stats-section-title learning">L√§r sig (' + inProgress.length + ')</div>';
    if (inProgress.length === 0) {
      html += '<div class="stats-empty">Inga ' + emptyLabel + ' p√•b√∂rjade √§nnu</div>';
    }
    for (const s of inProgress) {
      html += statsRowHtml(s);
    }

    statsList.innerHTML = html;
  }

  function statsRowHtml(s) {
    const streak = s.streak || 0;
    const total = s.correct + s.incorrect + s.assisted;
    const target = getMasteryStreak();
    let stars = "";
    for (let i = 0; i < target; i++) {
      stars += i < streak ? "&#x2605;" : "&#x2606;";
    }
    return '<div class="stats-row">'
      + '<span class="stats-word">' + escapeHtml(s.word) + '</span>'
      + '<div class="stats-counts">'
      + '<span class="stats-streak">' + stars + '</span>'
      + '<span class="stats-total">' + total + '</span>'
      + '</div></div>';
  }

  const aboutOverlay = document.getElementById("about-overlay");
  const btnAbout = document.getElementById("btn-about");
  const btnInfo = document.getElementById("btn-info");
  const btnCloseAbout = document.getElementById("btn-close-about");

  function openAbout() {
    settingsMenu.classList.remove("open");
    aboutOverlay.classList.add("open");
  }

  btnAbout.addEventListener("click", openAbout);
  btnInfo.addEventListener("click", openAbout);

  btnCloseAbout.addEventListener("click", () => {
    aboutOverlay.classList.remove("open");
  });

  btnShowStats.addEventListener("click", () => {
    settingsMenu.classList.remove("open");
    renderStats();
    statsOverlay.classList.add("open");
  });

  btnCloseStats.addEventListener("click", () => {
    statsOverlay.classList.remove("open");
  });

  // --- Event listeners ---

  btnSubmit.addEventListener("click", checkAnswer);
  btnShowAlt.addEventListener("click", showAlternatives);
  const slowTitles = ["Normal speed", "¬Ω speed (0.5√ó)", "¬º speed (0.25√ó)"];

  btnSlow.addEventListener("click", () => {
    slowMode = (slowMode + 1) % 3;
    btnSlow.classList.toggle("speed-1", slowMode === 1);
    btnSlow.classList.toggle("speed-2", slowMode === 2);
    btnSlow.title = slowTitles[slowMode];
    video.playbackRate = slowRates[slowMode];
  });

  btnFace.addEventListener("click", () => {
    const container = video.closest(".video-container");
    const zoomed = container.classList.toggle("face-zoom");
    btnFace.classList.toggle("active", zoomed);
  });

  answerInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      checkAnswer();
    }
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === " " && document.activeElement !== answerInput) {
      e.preventDefault();
      video.currentTime = 0;
      video.playbackRate = slowRates[slowMode];
      video.play().catch(() => {});
    }
  });

  // --- Init ---
  renderWordlistDropdown();
  updateProgressDisplay();
  updatePhraseBtnState();
  nextRound();

})();
</script>
</body>
</html>
