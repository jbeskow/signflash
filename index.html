<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<title>SignFlash</title>
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="manifest" href="manifest.json">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  overflow-x: hidden;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #1a1a2e;
  color: #e0e0e0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.progress-bar-container {
  width: 100%;
  background: #16213e;
  padding: 8px 16px;
  position: sticky;
  top: 0;
  z-index: 10;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.top-row {
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
}

.settings-wrap {
  position: absolute;
  right: 0;
}

.btn-settings {
  background: none;
  border: none;
  color: #888;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  display: flex;
  align-items: center;
}

.btn-settings:hover { color: #ccc; background: rgba(255,255,255,0.05); }

.settings-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 100%;
  margin-top: 4px;
  background: #16213e;
  border: 1px solid #0f3460;
  border-radius: 8px;
  padding: 4px 0;
  min-width: 180px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.4);
  z-index: 20;
}

.settings-menu.open { display: block; }

.settings-item {
  display: block;
  width: 100%;
  padding: 10px 16px;
  background: none;
  border: none;
  color: #e0e0e0;
  font-size: 14px;
  text-align: left;
  cursor: pointer;
}

.settings-item:hover { background: rgba(255,255,255,0.05); }
.settings-item.danger { color: #e74c3c; }

.streak-setting {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: default;
}

.streak-setting:hover { background: none !important; }

.streak-btn {
  background: #0f3460;
  border: none;
  color: #e0e0e0;
  width: 28px;
  height: 28px;
  border-radius: 4px;
  font-size: 16px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.streak-btn:hover { background: #1a4a7a; }

#streak-value {
  min-width: 16px;
  text-align: center;
  font-weight: 600;
}

.stats-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: #1a1a2e;
  z-index: 100;
  flex-direction: column;
}

.stats-overlay.open {
  display: flex;
}

.stats-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: #16213e;
  border-bottom: 1px solid #0f3460;
}

.stats-header h2 {
  font-size: 18px;
  font-weight: 600;
}

.btn-close-stats {
  background: none;
  border: none;
  color: #888;
  font-size: 24px;
  cursor: pointer;
  padding: 4px 8px;
}

.btn-close-stats:hover { color: #ccc; }

.stats-list {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 8px 0;
}

.stats-section-title {
  padding: 10px 16px 4px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stats-section-title.mastered { color: #4ecca3; }
.stats-section-title.learning { color: #f0c040; }

.stats-row {
  display: flex;
  align-items: center;
  padding: 8px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.04);
}

.stats-word {
  flex: 1;
  font-size: 16px;
}

.stats-counts {
  display: flex;
  gap: 12px;
  font-size: 13px;
}

.stats-streak { color: #f0c040; letter-spacing: 1px; }
.stats-total { color: #888; min-width: 24px; text-align: right; }

.stats-empty {
  padding: 24px 16px;
  text-align: center;
  color: #555;
  font-size: 14px;
}

.progress-stats {
  display: flex;
  justify-content: center;
  gap: 24px;
  font-size: 13px;
  margin-bottom: 6px;
  flex-wrap: wrap;
}

.progress-stats span { opacity: 0.85; display: inline-block; }
.stat-mastered { color: #4ecca3; }
.stat-learning { color: #f0c040; }
.stat-unseen { color: #888; }

.progress-track {
  width: 100%;
  max-width: 500px;
  height: 6px;
  background: #0f3460;
  border-radius: 3px;
  overflow: hidden;
  margin: 0 auto;
  display: flex;
}

.progress-fill-mastered {
  background: #4ecca3;
  height: 100%;
  transition: width 0.4s;
}

.progress-fill-learning {
  background: #f0c040;
  height: 100%;
  transition: width 0.4s;
}

.app {
  width: 100%;
  max-width: 500px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  flex: 1;
}

.video-container {
  width: 100%;
  aspect-ratio: 4 / 3;
  background: #000;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
}

video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.video-controls {
  position: absolute;
  bottom: 8px;
  right: 8px;
  display: flex;
  gap: 6px;
}

.btn-icon {
  background: rgba(0,0,0,0.6);
  border: none;
  color: #fff;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
}

.btn-icon:hover { background: rgba(0,0,0,0.8); }

.input-row {
  display: flex;
  gap: 8px;
  width: 100%;
}

#answer-input {
  flex: 1;
  padding: 12px 16px;
  font-size: 18px;
  border: 2px solid #0f3460;
  border-radius: 8px;
  background: #16213e;
  color: #e0e0e0;
  outline: none;
  transition: border-color 0.2s;
}

#answer-input:focus { border-color: #4ecca3; }
#answer-input::placeholder { color: #555; }

.btn {
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s, transform 0.1s;
}

.btn:active { transform: scale(0.97); }

.btn-submit {
  background: #4ecca3;
  color: #1a1a2e;
}

.btn-submit:hover { background: #3dbb94; }

.btn-alt {
  background: #0f3460;
  color: #e0e0e0;
  font-size: 14px;
  padding: 12px 14px;
}

.btn-alt:hover { background: #1a4a7a; }

.alternatives {
  display: none;
  width: 100%;
  gap: 8px;
}

.alternatives.visible {
  display: grid;
  grid-template-columns: 1fr 1fr;
}

.alt-btn {
  padding: 10px;
  border: 2px solid #0f3460;
  border-radius: 8px;
  background: #16213e;
  color: #e0e0e0;
  font-size: 15px;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
}

.alt-btn:hover {
  border-color: #4ecca3;
  background: #1a3a5e;
}

.feedback {
  width: 100%;
  padding: 16px;
  border-radius: 10px;
  text-align: center;
  font-size: 18px;
  font-weight: 600;
  display: none;
}

.feedback.correct {
  display: block;
  background: rgba(78, 204, 163, 0.15);
  color: #4ecca3;
  border: 2px solid #4ecca3;
}

.feedback.incorrect {
  display: block;
  background: rgba(231, 76, 60, 0.15);
  color: #e74c3c;
  border: 2px solid #e74c3c;
}

.feedback .correct-answer {
  margin-top: 6px;
  font-size: 22px;
  color: #f0c040;
}

.streak-stars {
  color: #f0c040;
  font-size: 20px;
  letter-spacing: 2px;
  margin-left: 4px;
}

.feedback.mastered-celebration {
  background: rgba(240, 192, 64, 0.15);
  border-color: #f0c040;
  color: #f0c040;
  animation: celebrate 0.6s ease-out;
}

@keyframes celebrate {
  0% { transform: scale(0.8); opacity: 0; }
  50% { transform: scale(1.08); }
  100% { transform: scale(1); opacity: 1; }
}

.stat-mastered.pulse {
  animation: counter-pulse 0.6s ease-out;
}

@keyframes counter-pulse {
  0% { transform: scale(1); }
  30% { transform: scale(1.4); color: #f0c040; }
  100% { transform: scale(1); }
}

.milestone {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.5);
  background: rgba(22, 33, 62, 0.95);
  border: 2px solid #f0c040;
  border-radius: 16px;
  padding: 24px 32px;
  text-align: center;
  color: #f0c040;
  font-size: 20px;
  font-weight: 700;
  z-index: 200;
  opacity: 0;
  pointer-events: none;
  animation: milestone-pop 2.5s ease-out forwards;
}

@keyframes milestone-pop {
  0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
  15% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
  25% { transform: translate(-50%, -50%) scale(1); }
  75% { opacity: 1; }
  100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
}

.mode-toggle {
  display: flex;
  gap: 0;
  flex-shrink: 0;
}

.mode-btn {
  flex: 1;
  padding: 8px;
  border: 2px solid #0f3460;
  background: transparent;
  color: #888;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.mode-btn:first-child {
  border-radius: 8px 0 0 8px;
  border-right: 1px solid #0f3460;
}

.mode-btn:last-child {
  border-radius: 0 8px 8px 0;
  border-left: 1px solid #0f3460;
}

.mode-btn.active {
  background: #0f3460;
  color: #e0e0e0;
  border-color: #0f3460;
}

.mode-btn:hover:not(.active) {
  color: #ccc;
  background: rgba(255,255,255,0.03);
}

.phrase-text {
  width: 100%;
  padding: 12px 16px;
  background: #16213e;
  border-radius: 8px;
  font-size: 16px;
  line-height: 1.5;
  color: #ccc;
  text-align: center;
  display: none;
}

.wordlist-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
}

.wordlist-select-wrap {
  position: relative;
  flex: 1;
}

.wordlist-btn {
  width: 100%;
  padding: 8px 12px;
  background: #0f3460;
  border: 2px solid #0f3460;
  border-radius: 8px;
  color: #e0e0e0;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  text-align: left;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: background 0.2s;
}

.wordlist-btn:hover { background: #1a4a7a; }

.wordlist-btn .wl-count {
  color: #888;
  font-weight: 400;
}

.wordlist-btn::after {
  content: "\25BE";
  margin-left: auto;
  font-size: 12px;
  color: #888;
}

.wordlist-menu {
  display: none;
  position: absolute;
  left: 0;
  right: 0;
  top: 100%;
  margin-top: 4px;
  background: #16213e;
  border: 1px solid #0f3460;
  border-radius: 8px;
  padding: 4px 0;
  box-shadow: 0 4px 16px rgba(0,0,0,0.4);
  z-index: 30;
  max-height: 300px;
  overflow-y: auto;
}

.wordlist-menu.open { display: block; }

.wordlist-menu-item {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
  padding: 10px 12px;
  background: none;
  border: none;
  color: #e0e0e0;
  font-size: 14px;
  text-align: left;
  cursor: pointer;
}

.wordlist-menu-item:hover { background: rgba(255,255,255,0.05); }
.wordlist-menu-item.active { background: rgba(78,204,163,0.1); }

.wordlist-menu-item .wl-check {
  width: 18px;
  text-align: center;
  color: #4ecca3;
  flex-shrink: 0;
}

.wordlist-menu-item .wl-name { flex: 1; }

.wordlist-menu-item .wl-count {
  color: #888;
  font-size: 13px;
}

.completion-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(26, 26, 46, 0.95);
  z-index: 250;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  gap: 16px;
}

.completion-overlay.open {
  display: flex;
  animation: celebrate 0.6s ease-out;
}

.completion-title {
  font-size: 32px;
  font-weight: 700;
  color: #f0c040;
}

.completion-subtitle {
  font-size: 18px;
  color: #ccc;
}

.completion-stars {
  font-size: 48px;
  letter-spacing: 8px;
}

.btn-completion-close {
  margin-top: 16px;
  padding: 12px 32px;
  background: #4ecca3;
  color: #1a1a2e;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
}

.btn-completion-close:hover { background: #3dbb94; }

@media (max-width: 520px) {
  .app { padding: 10px; gap: 12px; }
  #answer-input { font-size: 16px; padding: 10px 12px; }
  .btn { padding: 10px 14px; font-size: 14px; }
  .btn-alt { padding: 10px 10px; font-size: 13px; }
  .progress-stats { font-size: 12px; gap: 12px; }
}
</style>
</head>
<body>

<div class="progress-bar-container">
  <div class="top-row">
    <div class="progress-stats">
      <span class="stat-mastered" id="stat-mastered">Klara: 0</span>
      <span class="stat-learning" id="stat-learning">L√§r sig: 0</span>
      <span class="stat-unseen" id="stat-unseen">Nya: 0</span>
    </div>
    <div class="settings-wrap">
      <button class="btn-settings" id="btn-settings" title="Meny"><svg width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="5" x2="17" y2="5"/><line x1="3" y1="10" x2="17" y2="10"/><line x1="3" y1="15" x2="17" y2="15"/></svg></button>
      <div class="settings-menu" id="settings-menu">
        <button class="settings-item" id="btn-show-stats">Statistik</button>
        <div class="settings-item streak-setting">
          R√§tt i rad: <button class="streak-btn" id="streak-down">&#x2212;</button>
          <span id="streak-value">3</span>
          <button class="streak-btn" id="streak-up">+</button>
        </div>
        <button class="settings-item" id="btn-about">Om...</button>
        <button class="settings-item danger" id="btn-reset-progress">Nollst√§ll framsteg</button>
      </div>
    </div>
  </div>
  <div class="progress-track">
    <div class="progress-fill-mastered" id="progress-mastered"></div>
    <div class="progress-fill-learning" id="progress-learning"></div>
  </div>
</div>

<div class="app">
  <div class="wordlist-bar">
    <div class="wordlist-select-wrap">
      <button class="wordlist-btn" id="wordlist-btn">
        <span id="wordlist-btn-name">Grunder 1</span>
        <span class="wl-count" id="wordlist-btn-count"></span>
      </button>
      <div class="wordlist-menu" id="wordlist-menu"></div>
    </div>
    <div class="mode-toggle">
      <button class="mode-btn active" id="btn-mode-word">Ord</button>
      <button class="mode-btn" id="btn-mode-phrase">Fraser</button>
    </div>
  </div>

  <div class="video-container">
    <video id="sign-video" autoplay loop muted playsinline>
      <source id="video-source" src="" type="video/mp4">
    </video>
    <div class="video-controls">
      <button class="btn-icon" id="btn-replay" title="Replay">&#x21bb;</button>
    </div>
  </div>

  <div class="phrase-text" id="phrase-text"></div>

  <div class="input-row">
    <input type="text" id="answer-input" placeholder="Skriv ordet..." autocomplete="off" autocapitalize="none" spellcheck="false">
    <button class="btn btn-submit" id="btn-submit">OK</button>
    <button class="btn btn-alt" id="btn-show-alt">?</button>
  </div>

  <div class="alternatives" id="alternatives"></div>

  <div class="feedback" id="feedback"></div>
</div>

<div class="stats-overlay" id="about-overlay">
  <div class="stats-header">
    <h2>Om SignFlash</h2>
    <button class="btn-close-stats" id="btn-close-about">&times;</button>
  </div>
  <div style="padding: 20px; line-height: 1.6; color: #ccc;">
    <p>‚ö° SignFlash - tr√§na Svenskt Teckenspr√•k med flashcards!</p>
    <p>&#9757; Videor fr√•n <a href="https://teckensprakslexikon.su.se" target="_blank" rel="noopener" style="color: #818cf8;">Teckenspr√•kslexikon</a>, Stockholms universitet.</p>
    <p>üíö Vibekodat med k√§rlek av <a href="https://github.com/jbeskow" style="color: #818cf8;"">jbeskow</a></p>
    <p><a href="https://github.com/jbeskow/signflash" target="_blank" rel="noopener" style="color: #818cf8;"><svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="vertical-align: text-bottom; margin-right: 4px;"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>GitHub</a></p>
  </div>
</div>

<div class="stats-overlay" id="stats-overlay">
  <div class="stats-header">
    <h2>Statistik</h2>
    <button class="btn-close-stats" id="btn-close-stats">&times;</button>
  </div>
  <div class="stats-list" id="stats-list"></div>
</div>

<div class="completion-overlay" id="completion-overlay">
  <div class="completion-stars">&#x2B50;&#x2B50;&#x2B50;</div>
  <div class="completion-title">Alla ord klara!</div>
  <div class="completion-subtitle" id="completion-subtitle"></div>
  <button class="btn-completion-close" id="btn-completion-close">Forts√§tt</button>
</div>

<script src="wordlists/all.js"></script>
<script src="wordlist.js"></script>
<script src="phrases_cur.js"></script>
<script>
(function() {
  "use strict";

  const SETTINGS_KEY = "signflash_settings";
  const FEEDBACK_DELAY = 1800;
  const MASTERY_DELAY = 2500;

  // --- Wordlist registry ---

  // Fallback: if no wordlist files loaded WORDLISTS, use legacy WORDLIST
  if (!window.WORDLISTS || window.WORDLISTS.length === 0) {
    window.WORDLISTS = [{ id: "grunder1", name: "Grunder 1", words: WORDLIST }];
  }

  const DEFAULT_WORDLIST = "blandat1";
  let savedWl = loadSettings().wordlistId;
  let currentWordlistId = window.WORDLISTS.find(w => w.id === savedWl) ? savedWl
    : window.WORDLISTS.find(w => w.id === DEFAULT_WORDLIST) ? DEFAULT_WORDLIST
    : window.WORDLISTS[0].id;

  function getCurrentWordlist() {
    return window.WORDLISTS.find(w => w.id === currentWordlistId) || window.WORDLISTS[0];
  }

  // --- Phrase lookup (recomputed on wordlist change) ---

  let phrasesByWord = {};
  let phraseWordList = [];

  function recomputePhrases() {
    phrasesByWord = {};
    const wordSet = new Set(getCurrentWordlist().words.map(w => w.word));
    for (const p of PHRASELIST) {
      if (!wordSet.has(p.word)) continue;
      if (!phrasesByWord[p.word]) phrasesByWord[p.word] = [];
      phrasesByWord[p.word].push(p);
    }
    phraseWordList = Object.keys(phrasesByWord).map(w => ({ word: w }));
  }

  recomputePhrases();

  // --- Progress migration ---

  function migrateProgress() {
    const oldKey = "signflash_progress";
    const oldPhraseKey = "signflash_phrase_progress";
    const newKey = "signflash_progress_blandat1";
    const newPhraseKey = "signflash_phrase_progress_blandat1";

    if (localStorage.getItem(oldKey) && !localStorage.getItem(newKey)) {
      localStorage.setItem(newKey, localStorage.getItem(oldKey));
    }
    if (localStorage.getItem(oldPhraseKey) && !localStorage.getItem(newPhraseKey)) {
      localStorage.setItem(newPhraseKey, localStorage.getItem(oldPhraseKey));
    }
  }

  migrateProgress();

  function loadSettings() {
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; } catch { return {}; }
  }
  function saveSettings(s) { localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }
  function getMasteryStreak() { return loadSettings().masteryStreak || 3; }

  const video = document.getElementById("sign-video");
  const videoSource = document.getElementById("video-source");
  const answerInput = document.getElementById("answer-input");
  const btnSubmit = document.getElementById("btn-submit");
  const btnShowAlt = document.getElementById("btn-show-alt");
  const btnReplay = document.getElementById("btn-replay");
  const alternativesDiv = document.getElementById("alternatives");
  const feedbackDiv = document.getElementById("feedback");
  const phraseTextDiv = document.getElementById("phrase-text");
  const btnModeWord = document.getElementById("btn-mode-word");
  const btnModePhrase = document.getElementById("btn-mode-phrase");

  const MIN_GAP = 6;
  let currentItem = null;
  let currentPhrase = null;
  let recentWords = [];
  let usedAlternatives = false;
  let waitingForNext = false;
  let currentMode = "word";

  // --- Mode & storage keys ---

  function getStorageKey() {
    const base = currentMode === "phrase"
      ? "signflash_phrase_progress"
      : "signflash_progress";
    return base + "_" + currentWordlistId;
  }

  function getWordList() {
    return currentMode === "phrase" ? phraseWordList : getCurrentWordlist().words;
  }

  function setMode(mode) {
    if (mode === currentMode) return;
    currentMode = mode;
    recentWords = [];
    btnModeWord.classList.toggle("active", mode === "word");
    btnModePhrase.classList.toggle("active", mode === "phrase");
    answerInput.placeholder = mode === "phrase" ? "Skriv ordet som saknas..." : "Skriv ordet...";
    updateProgressDisplay();
    nextRound();
  }

  btnModeWord.addEventListener("click", () => setMode("word"));
  btnModePhrase.addEventListener("click", () => setMode("phrase"));

  // --- Progress persistence ---

  function loadProgress() {
    try {
      return JSON.parse(localStorage.getItem(getStorageKey())) || {};
    } catch { return {}; }
  }

  function saveProgress(progress) {
    localStorage.setItem(getStorageKey(), JSON.stringify(progress));
  }

  function getStats(word, progress) {
    return progress[word] || { correct: 0, incorrect: 0, assisted: 0, streak: 0, lastSeen: 0 };
  }

  // --- Word categorization ---

  function categorize(progress) {
    const wordList = getWordList();
    const unseen = [], struggling = [], assistedOnly = [], learning = [], mastered = [];

    for (const item of wordList) {
      const s = getStats(item.word, progress);
      const total = s.correct + s.incorrect + s.assisted;

      if (total === 0) {
        unseen.push(item);
        continue;
      }

      const streak = s.streak || 0;

      if (streak >= getMasteryStreak()) {
        mastered.push(item);
      } else if (s.correct === 0 && s.incorrect === 0 && s.assisted > 0) {
        assistedOnly.push(item);
      } else if (s.incorrect > s.correct) {
        struggling.push(item);
      } else {
        learning.push(item);
      }
    }

    return { unseen, struggling, assistedOnly, learning, mastered };
  }

  // Helper: count mastered for any wordlist id (used by dropdown)
  function countMastered(wlId) {
    const wl = window.WORDLISTS.find(w => w.id === wlId);
    if (!wl) return { mastered: 0, total: 0 };
    const key = "signflash_progress_" + wlId;
    let progress = {};
    try { progress = JSON.parse(localStorage.getItem(key)) || {}; } catch {}
    let mastered = 0;
    for (const item of wl.words) {
      const s = progress[item.word];
      if (s && (s.streak || 0) >= getMasteryStreak()) mastered++;
    }
    return { mastered, total: wl.words.length };
  }

  // --- Word selection ---

  function pickFromBucket(bucket, progress) {
    if (bucket.length === 0) return null;
    bucket.sort((a, b) => {
      const sa = getStats(a.word, progress).lastSeen;
      const sb = getStats(b.word, progress).lastSeen;
      return sa - sb;
    });
    const pool = bucket.slice(0, Math.max(3, Math.ceil(bucket.length / 4)));
    return pool[Math.floor(Math.random() * pool.length)];
  }

  function selectWord() {
    const wordList = getWordList();
    const progress = loadProgress();
    const cats = categorize(progress);

    const buckets = [
      { items: cats.struggling, weight: 35 },
      { items: cats.assistedOnly, weight: 25 },
      { items: cats.unseen, weight: 25 },
      { items: cats.learning, weight: 15 },
    ];

    const recentSet = new Set(recentWords);
    const filterRecent = (arr) => arr.filter(i => !recentSet.has(i.word));

    let totalWeight = 0;
    const available = [];
    for (const b of buckets) {
      const filtered = filterRecent(b.items);
      if (filtered.length > 0) {
        available.push({ items: filtered, weight: b.weight });
        totalWeight += b.weight;
      }
    }

    if (available.length === 0) {
      const unmastered = wordList.filter(i => {
        const s = getStats(i.word, progress);
        return (s.streak || 0) < getMasteryStreak();
      });
      if (unmastered.length > 0) {
        return unmastered[Math.floor(Math.random() * unmastered.length)];
      }
      return wordList[Math.floor(Math.random() * wordList.length)];
    }

    let roll = Math.random() * totalWeight;
    for (const b of available) {
      roll -= b.weight;
      if (roll <= 0) {
        return pickFromBucket(b.items, progress);
      }
    }

    return pickFromBucket(available[available.length - 1].items, progress);
  }

  // --- Phrase blanking ---

  function blankPhrase(phrase) {
    const blanked = phrase.replace(/\[[^\]]+\]/g, "___");
    if (blanked === phrase) return phrase + " ___";
    return blanked;
  }

  // --- Alternatives ---

  function getDistractors(correctWord, count) {
    const others = getCurrentWordlist().words.filter(i => i.word !== correctWord);
    const shuffled = others.slice().sort(() => Math.random() - 0.5);
    return shuffled.slice(0, count).map(i => i.word);
  }

  function showAlternatives() {
    usedAlternatives = true;
    const correct = currentItem.word;
    const distractors = getDistractors(correct, 3);
    const options = [correct, ...distractors].sort(() => Math.random() - 0.5);

    alternativesDiv.innerHTML = "";
    for (const opt of options) {
      const btn = document.createElement("button");
      btn.className = "alt-btn";
      btn.textContent = opt;
      btn.addEventListener("click", () => {
        answerInput.value = opt;
        checkAnswer();
      });
      alternativesDiv.appendChild(btn);
    }
    alternativesDiv.classList.add("visible");
    btnShowAlt.style.display = "none";
  }

  // --- Answer checking ---

  let pendingIncorrect = false;

  function checkAnswer() {
    if (waitingForNext) return;

    const answer = answerInput.value.trim().toLowerCase();
    if (!answer) return;

    const correct = currentItem.word.toLowerCase();
    let accepted = [correct];
    if (currentMode === "phrase" && currentPhrase) {
      const bracketed = currentPhrase.phrase.match(/\[([^\]]+)\]/g);
      if (bracketed) {
        for (const b of bracketed) {
          accepted.push(b.slice(1, -1).toLowerCase());
        }
      }
    }
    const isCorrect = accepted.includes(answer);

    if (isCorrect) {
      const progress = loadProgress();
      const stats = getStats(currentItem.word, progress);
      const unassisted = !usedAlternatives && !pendingIncorrect;
      if (unassisted) {
        stats.correct++;
        stats.streak = (stats.streak || 0) + 1;
      } else {
        stats.assisted++;
        stats.streak = 0;
      }
      stats.lastSeen = Date.now();
      progress[currentItem.word] = stats;
      saveProgress(progress);
      const justMastered = unassisted && stats.streak === getMasteryStreak();
      pendingIncorrect = false;
      showFeedback(true, currentItem.word, stats.streak, justMastered);
      updateProgressDisplay();
      if (justMastered) {
        const cats = categorize(progress);
        const masteredCount = cats.mastered.length;
        setTimeout(pulseCounter, 500);
        // Check completion
        if (masteredCount === getWordList().length) {
          setTimeout(() => showCompletion(), 600);
        } else if (masteredCount % 10 === 0) {
          setTimeout(() => showMilestone(masteredCount), 600);
        }
      }
    } else {
      const progress = loadProgress();
      const stats = getStats(currentItem.word, progress);
      stats.incorrect++;
      stats.streak = 0;
      stats.lastSeen = Date.now();
      progress[currentItem.word] = stats;
      saveProgress(progress);
      pendingIncorrect = true;
      updateProgressDisplay();
      answerInput.blur();
      setTimeout(scrollToTop, 100);
      showAlternatives();
    }
  }

  const isTouch = "ontouchstart" in window;

  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function focusInput() {
    if (!isTouch) answerInput.focus();
  }

  function pulseCounter() {
    const el = document.getElementById("stat-mastered");
    el.classList.remove("pulse");
    void el.offsetWidth;
    el.classList.add("pulse");
  }

  function showMilestone(count) {
    const el = document.createElement("div");
    el.className = "milestone";
    const label = currentMode === "phrase" ? " fraser klara, bra jobbat!" : " ord klara, bra jobbat!";
    el.textContent = count + label;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2600);
  }

  // --- Completion overlay ---

  const completionOverlay = document.getElementById("completion-overlay");
  const completionSubtitle = document.getElementById("completion-subtitle");
  const btnCompletionClose = document.getElementById("btn-completion-close");

  function showCompletion() {
    const wl = getCurrentWordlist();
    completionSubtitle.textContent = wl.name + " ‚Äî alla " + wl.words.length + " ord klara!";
    completionOverlay.classList.add("open");
    renderWordlistDropdown();
  }

  btnCompletionClose.addEventListener("click", () => {
    completionOverlay.classList.remove("open");
  });

  function makeStars(streak) {
    const target = getMasteryStreak();
    const clamped = Math.min(streak, target);
    let stars = "";
    for (let i = 0; i < target; i++) {
      stars += i < clamped ? "&#x2605;" : "&#x2606;";
    }
    return stars;
  }

  function showFeedback(isCorrect, correctWord, streak, justMastered) {
    waitingForNext = true;
    answerInput.blur();
    answerInput.disabled = true;
    btnSubmit.disabled = true;
    btnShowAlt.disabled = true;

    feedbackDiv.className = "feedback";

    if (isCorrect) {
      if (justMastered) {
        feedbackDiv.classList.add("correct", "mastered-celebration");
      } else {
        feedbackDiv.classList.add("correct");
      }
      let html = escapeHtml(correctWord)
        + ' <span class="streak-stars">' + makeStars(streak) + "</span>";
      if (currentMode === "phrase" && currentPhrase) {
        const filled = currentPhrase.phrase.replace(/\[([^\]]+)\]/g,
          function(_, m) { return '<span style="color:#4ecca3;font-weight:700">' + escapeHtml(m) + '</span>'; }
        );
        html = '<div style="font-size:15px;margin-bottom:8px;font-weight:400;color:#ccc">' + filled + '</div>' + html;
      }
      feedbackDiv.innerHTML = html;
    } else {
      feedbackDiv.classList.add("incorrect");
      feedbackDiv.innerHTML = escapeHtml(correctWord)
        + ' <span class="streak-stars">' + makeStars(0) + "</span>";
    }

    setTimeout(scrollToTop, 100);
    const delay = justMastered ? MASTERY_DELAY : FEEDBACK_DELAY;
    setTimeout(nextRound, delay);
  }

  function escapeHtml(s) {
    const d = document.createElement("div");
    d.textContent = s;
    return d.innerHTML;
  }

  // --- Round management ---

  function nextRound() {
    waitingForNext = false;
    usedAlternatives = false;
    pendingIncorrect = false;

    feedbackDiv.className = "feedback";
    feedbackDiv.innerHTML = "";
    alternativesDiv.classList.remove("visible");
    alternativesDiv.innerHTML = "";
    btnShowAlt.style.display = "";

    answerInput.value = "";
    answerInput.disabled = false;
    btnSubmit.disabled = false;
    btnShowAlt.disabled = false;

    if (currentItem) {
      recentWords.push(currentItem.word);
      if (recentWords.length > MIN_GAP) recentWords.shift();
    }

    const selected = selectWord();

    if (currentMode === "phrase") {
      const phrases = phrasesByWord[selected.word];
      currentPhrase = phrases[Math.floor(Math.random() * phrases.length)];
      currentItem = { word: selected.word, video: currentPhrase.video };
      phraseTextDiv.textContent = blankPhrase(currentPhrase.phrase);
      phraseTextDiv.style.display = "block";
    } else {
      currentItem = selected;
      currentPhrase = null;
      phraseTextDiv.style.display = "none";
    }

    const idMatch = currentItem.video.match(/-(\d{5})-/);
    const prefix = idMatch ? idMatch[1].substring(0, 2) : "00";
    videoSource.src = "https://teckensprakslexikon.su.se/movies/" + prefix + "/" + currentItem.video;
    video.load();
    video.play().catch(() => {});

    scrollToTop();
    focusInput();
  }

  // --- Progress display ---

  function updateProgressDisplay() {
    const progress = loadProgress();
    const cats = categorize(progress);
    const total = getWordList().length;

    document.getElementById("stat-mastered").textContent = "Klara: " + cats.mastered.length;
    document.getElementById("stat-learning").textContent =
      "L√§r sig: " + (cats.struggling.length + cats.assistedOnly.length + cats.learning.length);
    document.getElementById("stat-unseen").textContent = "Nya: " + cats.unseen.length;

    const masteredPct = (cats.mastered.length / total) * 100;
    const learningPct = ((total - cats.mastered.length - cats.unseen.length) / total) * 100;

    document.getElementById("progress-mastered").style.width = masteredPct + "%";
    document.getElementById("progress-learning").style.width = learningPct + "%";

    // Update wordlist button count
    const info = countMastered(currentWordlistId);
    document.getElementById("wordlist-btn-count").textContent = "(" + info.mastered + "/" + info.total + ")";
  }

  // --- Wordlist selector ---

  const wordlistBtn = document.getElementById("wordlist-btn");
  const wordlistMenu = document.getElementById("wordlist-menu");

  function renderWordlistDropdown() {
    document.getElementById("wordlist-btn-name").textContent = getCurrentWordlist().name;
    const info = countMastered(currentWordlistId);
    document.getElementById("wordlist-btn-count").textContent = "(" + info.mastered + "/" + info.total + ")";

    let html = "";
    for (const wl of window.WORDLISTS) {
      const m = countMastered(wl.id);
      const isActive = wl.id === currentWordlistId;
      const isComplete = m.mastered === m.total;
      html += '<button class="wordlist-menu-item' + (isActive ? ' active' : '') + '" data-wl-id="' + escapeHtml(wl.id) + '">'
        + '<span class="wl-check">' + (isComplete ? "\u2713" : "") + '</span>'
        + '<span class="wl-name">' + escapeHtml(wl.name) + '</span>'
        + '<span class="wl-count">(' + m.mastered + '/' + m.total + ')</span>'
        + '</button>';
    }
    wordlistMenu.innerHTML = html;

    // Bind click handlers
    for (const btn of wordlistMenu.querySelectorAll(".wordlist-menu-item")) {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-wl-id");
        switchWordlist(id);
        wordlistMenu.classList.remove("open");
      });
    }
  }

  function switchWordlist(id) {
    if (id === currentWordlistId) return;
    currentWordlistId = id;
    const s = loadSettings(); s.wordlistId = id; saveSettings(s);
    recentWords = [];
    recomputePhrases();
    renderWordlistDropdown();
    updateProgressDisplay();
    nextRound();
  }

  wordlistBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    renderWordlistDropdown();
    wordlistMenu.classList.toggle("open");
  });

  document.addEventListener("click", () => {
    wordlistMenu.classList.remove("open");
  });

  wordlistMenu.addEventListener("click", (e) => {
    e.stopPropagation();
  });

  // --- Settings menu ---

  const btnSettings = document.getElementById("btn-settings");
  const settingsMenu = document.getElementById("settings-menu");
  const btnResetProgress = document.getElementById("btn-reset-progress");

  btnSettings.addEventListener("click", (e) => {
    e.stopPropagation();
    settingsMenu.classList.toggle("open");
  });

  document.addEventListener("click", () => {
    settingsMenu.classList.remove("open");
  });

  // --- Streak setting ---

  const streakValueEl = document.getElementById("streak-value");
  const streakDown = document.getElementById("streak-down");
  const streakUp = document.getElementById("streak-up");

  streakValueEl.textContent = getMasteryStreak();

  streakDown.addEventListener("click", (e) => {
    e.stopPropagation();
    const s = loadSettings();
    const cur = s.masteryStreak || 3;
    if (cur > 1) {
      s.masteryStreak = cur - 1;
      saveSettings(s);
      streakValueEl.textContent = s.masteryStreak;
      updateProgressDisplay();
    }
  });

  streakUp.addEventListener("click", (e) => {
    e.stopPropagation();
    const s = loadSettings();
    const cur = s.masteryStreak || 3;
    if (cur < 10) {
      s.masteryStreak = cur + 1;
      saveSettings(s);
      streakValueEl.textContent = s.masteryStreak;
      updateProgressDisplay();
    }
  });

  btnResetProgress.addEventListener("click", () => {
    const label = currentMode === "phrase" ? "frasframsteg" : "alla framsteg";
    if (confirm("Nollst√§ll " + label + "? Detta kan inte √•ngras.")) {
      localStorage.removeItem(getStorageKey());
      updateProgressDisplay();
      renderWordlistDropdown();
      nextRound();
    }
  });

  // --- Stats overlay ---

  const statsOverlay = document.getElementById("stats-overlay");
  const statsList = document.getElementById("stats-list");
  const btnShowStats = document.getElementById("btn-show-stats");
  const btnCloseStats = document.getElementById("btn-close-stats");

  function renderStats() {
    const progress = loadProgress();
    const cats = categorize(progress);

    const mastered = cats.mastered.map(i => ({ word: i.word, ...getStats(i.word, progress) }));
    const inProgress = [...cats.struggling, ...cats.assistedOnly, ...cats.learning]
      .map(i => ({ word: i.word, ...getStats(i.word, progress) }));

    mastered.sort((a, b) => a.word.localeCompare(b.word, "sv"));
    inProgress.sort((a, b) => a.word.localeCompare(b.word, "sv"));

    const emptyLabel = currentMode === "phrase" ? "fraser" : "ord";
    let html = "";

    html += '<div class="stats-section-title mastered">Klara (' + mastered.length + ')</div>';
    if (mastered.length === 0) {
      html += '<div class="stats-empty">Inga ' + emptyLabel + ' klara √§nnu</div>';
    }
    for (const s of mastered) {
      html += statsRowHtml(s);
    }

    html += '<div class="stats-section-title learning">L√§r sig (' + inProgress.length + ')</div>';
    if (inProgress.length === 0) {
      html += '<div class="stats-empty">Inga ' + emptyLabel + ' p√•b√∂rjade √§nnu</div>';
    }
    for (const s of inProgress) {
      html += statsRowHtml(s);
    }

    statsList.innerHTML = html;
  }

  function statsRowHtml(s) {
    const streak = s.streak || 0;
    const total = s.correct + s.incorrect + s.assisted;
    const target = getMasteryStreak();
    let stars = "";
    for (let i = 0; i < target; i++) {
      stars += i < streak ? "&#x2605;" : "&#x2606;";
    }
    return '<div class="stats-row">'
      + '<span class="stats-word">' + escapeHtml(s.word) + '</span>'
      + '<div class="stats-counts">'
      + '<span class="stats-streak">' + stars + '</span>'
      + '<span class="stats-total">' + total + '</span>'
      + '</div></div>';
  }

  const aboutOverlay = document.getElementById("about-overlay");
  const btnAbout = document.getElementById("btn-about");
  const btnCloseAbout = document.getElementById("btn-close-about");

  btnAbout.addEventListener("click", () => {
    settingsMenu.classList.remove("open");
    aboutOverlay.classList.add("open");
  });

  btnCloseAbout.addEventListener("click", () => {
    aboutOverlay.classList.remove("open");
  });

  btnShowStats.addEventListener("click", () => {
    settingsMenu.classList.remove("open");
    renderStats();
    statsOverlay.classList.add("open");
  });

  btnCloseStats.addEventListener("click", () => {
    statsOverlay.classList.remove("open");
  });

  // --- Event listeners ---

  btnSubmit.addEventListener("click", checkAnswer);
  btnShowAlt.addEventListener("click", showAlternatives);
  btnReplay.addEventListener("click", () => {
    video.currentTime = 0;
    video.play().catch(() => {});
  });

  answerInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      checkAnswer();
    }
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === " " && document.activeElement !== answerInput) {
      e.preventDefault();
      video.currentTime = 0;
      video.play().catch(() => {});
    }
  });

  // --- Init ---
  renderWordlistDropdown();
  updateProgressDisplay();
  nextRound();

})();
</script>
</body>
</html>
